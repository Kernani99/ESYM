<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SYM Algeria - المهام اليومية</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #e30613;
            --primary-dark: #c00510;
            --secondary-color: #333;
            --light-color: #f8f9fa;
            --dark-color: #212529;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background-color: #f5f5f5;
            color: var(--dark-color);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .navbar {
            background-color: var(--primary-color) !important;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .navbar-brand {
            font-weight: 700;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
        }

        .nav-link {
            font-weight: 600;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .nav-link:hover, .nav-link.active {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card-header {
            background-color: var(--primary-color);
            color: white;
            border-bottom: none;
            font-weight: 700;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .task-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            margin-bottom: 10px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            border-left: 4px solid var(--primary-color);
            cursor: pointer;
        }

        .task-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        }

        .task-text {
            flex-grow: 1;
            margin: 0 12px;
            font-weight: 500;
        }

        .task-actions {
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .task-item:hover .task-actions {
            opacity: 1;
        }

        .task-status {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
            min-width: 90px;
            text-align: center;
        }

        .status-pending {
            background-color: #fff3cd;
            color: #856404;
        }

        .status-in-progress {
            background-color: #cce5ff;
            color: #004085;
        }

        .status-completed {
            background-color: #d4edda;
            color: #155724;
        }

        .note-item {
            background-color: #f8f9fa;
            border-left: 4px solid var(--primary-color);
            padding: 12px;
            margin-bottom: 12px;
            border-radius: 0 8px 8px 0;
            position: relative;
            transition: all 0.3s ease;
        }

        .note-item:hover {
            background-color: #e9ecef;
        }

        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
            border-color: var(--primary-dark);
        }

        .btn-outline-primary {
            color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .btn-outline-primary:hover {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
        }

        .progress {
            height: 12px;
            border-radius: 6px;
            background-color: #e9ecef;
        }

        .progress-bar {
            background-color: var(--primary-color);
            transition: width 0.6s ease;
        }

        .form-control, .form-select {
            border-radius: 8px;
            padding: 10px 15px;
            border: 1px solid #ddd;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.25rem rgba(227, 6, 19, 0.25);
        }

        .logo {
            height: 40px;
            margin-right: 10px;
        }

        .footer {
            background-color: var(--dark-color);
            color: white;
            padding: 20px 0;
            margin-top: auto;
        }

        .date-navigation {
            display: flex;
            align-items: center;
        }

        .date-display {
            background-color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            margin: 0 10px;
        }

        /* تعديلات RTL */
        [dir="rtl"] .me-2 {
            margin-left: 0.5rem !important;
            margin-right: 0 !important;
        }

        [dir="rtl"] .ms-2 {
            margin-right: 0.5rem !important;
            margin-left: 0 !important;
        }

        /* تحسينات للواجهة على الأجهزة الصغيرة */
        @media (max-width: 768px) {
            .navbar-brand {
                font-size: 1.2rem;
            }
            
            .task-item {
                flex-wrap: wrap;
                padding: 10px;
            }
            
            .task-status {
                margin: 5px 0;
                width: 100%;
            }
            
            .task-actions {
                opacity: 1;
                margin-top: 5px;
            }
        }

        /* تأثيرات للتفاعل */
        .btn {
            transition: all 0.3s ease;
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* تحسينات للواجهة */
        .empty-state {
            text-align: center;
            padding: 30px;
            color: #6c757d;
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            color: #dee2e6;
        }

        .loading-spinner {
            display: inline-block;
            width: 2rem;
            height: 2rem;
            vertical-align: text-bottom;
            border: 0.25em solid currentColor;
            border-right-color: transparent;
            border-radius: 50%;
            animation: spinner-border .75s linear infinite;
        }

        @keyframes spinner-border {
            to { transform: rotate(360deg); }
        }

        #error-message {
            display: none;
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            max-width: 80%;
            z-index: 1000;
        }

        #connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background-color: #ccc;
            z-index: 1000;
        }

        .online { background-color: #28a745; }
        .offline { background-color: #dc3545; }
    </style>
</head>
<body>
    <div id="connection-status" class="offline"></div>
    
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="#">
                <img src="https://via.placeholder.com/150x50?text=SYM+Algeria" alt="SYM Algeria" class="logo">
                نظام إدارة المهام
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="#">
                            <i class="fas fa-calendar-day me-1"></i> المهام اليومية
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">
                            <i class="fas fa-calendar-week me-1"></i> المواعيد
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">
                            <i class="fas fa-boxes me-1"></i> المخزون
                        </a>
                    </li>
                </ul>
                <div class="d-flex">
                    <button id="logoutBtn" class="btn btn-outline-light">
                        <i class="fas fa-sign-out-alt me-1"></i> تسجيل الخروج
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="container my-5" id="main-app">
        <div class="row">
            <div class="col-lg-8 mx-auto">
                <div class="card shadow">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center flex-wrap">
                            <h4 class="mb-0">
                                <i class="fas fa-list-check me-2"></i>قائمة المهام اليومية
                            </h4>
                            <div class="date-navigation mt-2 mt-md-0">
                                <button id="prevDayBtn" class="btn btn-sm btn-light">
                                    <i class="fas fa-arrow-right"></i> اليوم السابق
                                </button>
                                <div class="date-display" id="currentDateDisplay"></div>
                                <button id="nextDayBtn" class="btn btn-sm btn-light">
                                    اليوم التالي <i class="fas fa-arrow-left"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="input-group mb-4">
                            <input type="text" id="newTaskInput" class="form-control" placeholder="أضف مهمة جديدة..." autocomplete="off">
                            <button class="btn btn-primary" id="addTaskBtn">
                                <i class="fas fa-plus me-1"></i> إضافة
                            </button>
                        </div>
                        
                        <div class="mb-4">
                            <textarea id="newNoteInput" class="form-control" placeholder="أضف ملاحظة..." rows="3" autocomplete="off"></textarea>
                            <button class="btn btn-secondary mt-2" id="addNoteBtn">
                                <i class="fas fa-note-sticky me-1"></i> حفظ الملاحظة
                            </button>
                        </div>
                        
                        <div id="notesSection" class="mb-4 p-3 bg-light rounded">
                            <h5><i class="fas fa-notes me-2"></i>الملاحظات</h5>
                            <div id="notesList">
                                <div class="text-center py-3">
                                    <div class="loading-spinner text-primary"></div>
                                    <p class="mt-2">جاري تحميل الملاحظات...</p>
                                </div>
                            </div>
                        </div>
                        
                        <div id="tasksList">
                            <div class="text-center py-3">
                                <div class="loading-spinner text-primary"></div>
                                <p class="mt-2">جاري تحميل المهام...</p>
                            </div>
                        </div>
                        
                        <div class="mt-4">
                            <div class="progress">
                                <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                            </div>
                            <small class="text-muted" id="progressText">0% مكتمل (0 من 0 مهمة)</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة تعديل المهمة -->
    <div class="modal fade" id="editTaskModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">تعديل المهمة</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editTaskId">
                    <input type="text" id="editTaskInput" class="form-control mb-3" autocomplete="off">
                    <select id="editTaskStatus" class="form-select">
                        <option value="pending">قيد الإنتظار</option>
                        <option value="in-progress">قيد التنفيذ</option>
                        <option value="completed">مكتملة</option>
                    </select>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" id="saveTaskBtn" class="btn btn-primary">حفظ التغييرات</button>
                    <button type="button" id="deleteTaskBtn" class="btn btn-danger">حذف المهمة</button>
                </div>
            </div>
        </div>
    </div>

    <div id="error-message" class="alert alert-danger text-center">
        <i class="fas fa-exclamation-triangle me-2"></i>
        <span id="error-text"></span>
        <button class="btn btn-sm btn-outline-danger ms-3" onclick="location.reload()">
            <i class="fas fa-sync-alt me-1"></i> إعادة المحاولة
        </button>
    </div>

    <footer class="footer">
        <div class="container text-center">
            <p class="mb-0">جميع الحقوق محفوظة &copy; <span id="currentYear"></span> SYM Algeria</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script>
        // 1. تهيئة Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDvHZPvH5q1qX5Q5Zv5X5Zv5X5Zv5X5Zv5",
            authDomain: "commercial-3ef19.firebaseapp.com",
            databaseURL: "https://commercial-3ef19-default-rtdb.firebaseio.com",
            projectId: "commercial-3ef19",
            storageBucket: "commercial-3ef19.appspot.com",
            messagingSenderId: "1234567890",
            appId: "1:1234567890:web:abcdef1234567890"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();

        // 2. متغيرات التطبيق
        let currentDate = new Date();
        let currentTaskId = null;
        let currentTasks = [];
        let currentNotes = [];

        // 3. وظائف مساعدة
        function formatDisplayDate(date) {
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            return date.toLocaleDateString('ar-EG', options);
        }
        
        function formatDatabaseDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function showError(message) {
            const errorMessage = document.getElementById('error-message');
            document.getElementById('error-text').textContent = message;
            errorMessage.style.display = 'block';
            document.getElementById('main-app').style.opacity = '0.5';
        }

        function hideError() {
            document.getElementById('error-message').style.display = 'none';
            document.getElementById('main-app').style.opacity = '1';
        }

        function updateConnectionStatus(connected) {
            const statusElement = document.getElementById('connection-status');
            statusElement.className = connected ? 'online' : 'offline';
        }

        function createTaskElement(task) {
            const taskElement = document.createElement('div');
            taskElement.className = 'task-item fade-in';
            taskElement.dataset.id = task.id;
            
            const statusClass = {
                'pending': 'status-pending',
                'in-progress': 'status-in-progress',
                'completed': 'status-completed'
            }[task.status] || 'status-pending';
            
            const statusText = {
                'pending': 'قيد الإنتظار',
                'in-progress': 'قيد التنفيذ',
                'completed': 'مكتملة'
            }[task.status] || 'قيد الإنتظار';
            
            taskElement.innerHTML = `
                <input type="checkbox" ${task.status === 'completed' ? 'checked' : ''} class="form-check-input me-2">
                <div class="task-text">${task.text}</div>
                <div class="task-status ${statusClass}">${statusText}</div>
                <div class="task-actions">
                    <button class="btn btn-sm btn-outline-primary edit-task">
                        <i class="fas fa-edit"></i>
                    </button>
                </div>
            `;
            
            // إضافة أحداث النقر
            taskElement.querySelector('.edit-task').addEventListener('click', (e) => {
                e.stopPropagation();
                openEditModal(task);
            });
            
            taskElement.querySelector('input[type="checkbox"]').addEventListener('change', (e) => {
                updateTaskStatus(task.id, e.target.checked ? 'completed' : 'pending');
            });
            
            taskElement.addEventListener('click', () => {
                openEditModal(task);
            });
            
            return taskElement;
        }

        function openEditModal(task) {
            currentTaskId = task.id;
            document.getElementById('editTaskId').value = task.id;
            document.getElementById('editTaskInput').value = task.text;
            document.getElementById('editTaskStatus').value = task.status;
            
            const modal = new bootstrap.Modal(document.getElementById('editTaskModal'));
            modal.show();
        }

        function showEmptyTasksState() {
            tasksList.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-tasks"></i>
                    <h5>لا توجد مهام لهذا اليوم</h5>
                    <p class="text-muted">ابدأ بإضافة مهام جديدة باستخدام حقل الإدخال بالأعلى</p>
                </div>
            `;
        }

        function showEmptyNotesState() {
            notesList.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-sticky-note"></i>
                    <h5>لا توجد ملاحظات</h5>
                    <p class="text-muted">يمكنك إضافة ملاحظات جديدة باستخدام حقل الملاحظات بالأعلى</p>
                </div>
            `;
        }

        // 4. وظائف إدارة المهام
        function addTask(taskText) {
            if (!taskText.trim()) return;
            
            const dateKey = formatDatabaseDate(currentDate);
            const userId = auth.currentUser?.uid;
            
            if (!userId) {
                showError('يجب تسجيل الدخول أولاً');
                return;
            }
            
            const newTaskRef = database.ref(`users/${userId}/tasks/${dateKey}`).push();
            newTaskRef.set({
                text: taskText,
                status: 'pending',
                createdAt: firebase.database.ServerValue.TIMESTAMP
            }).then(() => {
                document.getElementById('newTaskInput').value = '';
            }).catch((error) => {
                console.error('Error adding task:', error);
                showError('حدث خطأ أثناء إضافة المهمة');
            });
        }

        function updateTask(taskId, newText, newStatus) {
            const dateKey = formatDatabaseDate(currentDate);
            const userId = auth.currentUser?.uid;
            
            if (!userId) return;
            
            database.ref(`users/${userId}/tasks/${dateKey}/${taskId}`).update({
                text: newText,
                status: newStatus
            }).catch((error) => {
                console.error('Error updating task:', error);
                showError('حدث خطأ أثناء تحديث المهمة');
            });
        }

        function updateTaskStatus(taskId, newStatus) {
            const dateKey = formatDatabaseDate(currentDate);
            const userId = auth.currentUser?.uid;
            
            if (!userId) return;
            
            database.ref(`users/${userId}/tasks/${dateKey}/${taskId}`).update({
                status: newStatus
            }).catch((error) => {
                console.error('Error updating task status:', error);
                showError('حدث خطأ أثناء تحديث حالة المهمة');
            });
        }

        function deleteTask(taskId) {
            const dateKey = formatDatabaseDate(currentDate);
            const userId = auth.currentUser?.uid;
            
            if (!userId) return;
            
            database.ref(`users/${userId}/tasks/${dateKey}/${taskId}`).remove()
                .catch((error) => {
                    console.error('Error deleting task:', error);
                    showError('حدث خطأ أثناء حذف المهمة');
                });
        }

        // 5. وظائف إدارة الملاحظات
        function addNote(noteText) {
            if (!noteText.trim()) return;
            
            const dateKey = formatDatabaseDate(currentDate);
            const userId = auth.currentUser?.uid;
            
            if (!userId) {
                showError('يجب تسجيل الدخول أولاً');
                return;
            }
            
            const newNoteRef = database.ref(`users/${userId}/notes/${dateKey}`).push();
            newNoteRef.set({
                text: noteText,
                createdAt: firebase.database.ServerValue.TIMESTAMP
            }).then(() => {
                document.getElementById('newNoteInput').value = '';
            }).catch((error) => {
                console.error('Error adding note:', error);
                showError('حدث خطأ أثناء إضافة الملاحظة');
            });
        }

        // 6. تحميل البيانات
        function loadTasks() {
            const dateKey = formatDatabaseDate(currentDate);
            const userId = auth.currentUser?.uid;
            
            if (!userId) return;
            
            tasksList.innerHTML = `
                <div class="text-center py-3">
                    <div class="loading-spinner text-primary"></div>
                    <p class="mt-2">جاري تحميل المهام...</p>
                </div>
            `;
            
            database.ref(`users/${userId}/tasks/${dateKey}`).on('value', (snapshot) => {
                tasksList.innerHTML = '';
                currentTasks = [];
                
                if (snapshot.exists()) {
                    const tasksData = snapshot.val();
                    currentTasks = Object.entries(tasksData).map(([id, task]) => ({ id, ...task }));
                    
                    // حساب نسبة الإنجاز
                    const completedTasks = currentTasks.filter(task => task.status === 'completed').length;
                    const totalTasks = currentTasks.length;
                    const completionPercentage = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
                    
                    progressBar.style.width = `${completionPercentage}%`;
                    progressText.textContent = `${completionPercentage}% مكتمل (${completedTasks} من ${totalTasks} مهمة)`;
                    
                    // عرض المهام
                    if (currentTasks.length > 0) {
                        currentTasks.forEach(task => {
                            const taskElement = createTaskElement(task);
                            tasksList.appendChild(taskElement);
                        });
                    } else {
                        showEmptyTasksState();
                    }
                } else {
                    progressBar.style.width = '0%';
                    progressText.textContent = '0% مكتمل (0 من 0 مهمة)';
                    showEmptyTasksState();
                }
            }, (error) => {
                console.error('Error loading tasks:', error);
                showError('حدث خطأ أثناء تحميل المهام. يرجى المحاولة مرة أخرى.');
            });
        }

        function loadNotes() {
            const dateKey = formatDatabaseDate(currentDate);
            const userId = auth.currentUser?.uid;
            
            if (!userId) return;
            
            notesList.innerHTML = `
                <div class="text-center py-3">
                    <div class="loading-spinner text-primary"></div>
                    <p class="mt-2">جاري تحميل الملاحظات...</p>
                </div>
            `;
            
            database.ref(`users/${userId}/notes/${dateKey}`).on('value', (snapshot) => {
                notesList.innerHTML = '';
                currentNotes = [];
                
                if (snapshot.exists()) {
                    const notesData = snapshot.val();
                    currentNotes = Object.entries(notesData).map(([id, note]) => ({ id, ...note }));
                    
                    if (currentNotes.length > 0) {
                        currentNotes.forEach(note => {
                            const noteElement = document.createElement('div');
                            noteElement.className = 'note-item fade-in';
                            noteElement.innerHTML = `
                                <p>${note.text}</p>
                                <small class="text-muted">${new Date(note.createdAt).toLocaleString('ar-EG')}</small>
                            `;
                            notesList.appendChild(noteElement);
                        });
                    } else {
                        showEmptyNotesState();
                    }
                } else {
                    showEmptyNotesState();
                }
            }, (error) => {
                console.error('Error loading notes:', error);
                showError('حدث خطأ أثناء تحميل الملاحظات. يرجى المحاولة مرة أخرى.');
            });
        }

        // 7. التحقق من الاتصال
        function checkConnection() {
            // التحقق من اتصال الإنترنت
            if (!navigator.onLine) {
                showError('لا يوجد اتصال بالإنترنت. يرجى التحقق من اتصالك ثم إعادة تحميل الصفحة.');
                updateConnectionStatus(false);
                return false;
            }

            // التحقق من اتصال Firebase
            const databaseRef = database.ref('.info/connected');
            databaseRef.on('value', (snap) => {
                if (snap.val() === true) {
                    updateConnectionStatus(true);
                    hideError();
                } else {
                    updateConnectionStatus(false);
                    showError('لا يوجد اتصال بخادم البيانات. يرجى المحاولة لاحقًا.');
                }
            });

            return true;
        }

        // 8. تهيئة التطبيق
        function initApp() {
            // تعيين سنة حقوق النشر
            document.getElementById('currentYear').textContent = new Date().getFullYear();
            
            // تحديث عرض التاريخ والبيانات
            function updateDateDisplay() {
                document.getElementById('currentDateDisplay').textContent = formatDisplayDate(currentDate);
                loadTasks();
                loadNotes();
            }
            
            // أحداث الأزرار
            document.getElementById('addTaskBtn').addEventListener('click', () => {
                const taskText = document.getElementById('newTaskInput').value;
                addTask(taskText);
            });
            
            document.getElementById('newTaskInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    const taskText = document.getElementById('newTaskInput').value;
                    addTask(taskText);
                }
            });
            
            document.getElementById('addNoteBtn').addEventListener('click', () => {
                const noteText = document.getElementById('newNoteInput').value;
                addNote(noteText);
            });
            
            document.getElementById('saveTaskBtn').addEventListener('click', () => {
                const newText = document.getElementById('editTaskInput').value;
                const newStatus = document.getElementById('editTaskStatus').value;
                updateTask(currentTaskId, newText, newStatus);
                bootstrap.Modal.getInstance(document.getElementById('editTaskModal')).hide();
            });
            
            document.getElementById('deleteTaskBtn').addEventListener('click', () => {
                if (confirm('هل أنت متأكد من حذف هذه المهمة؟')) {
                    deleteTask(currentTaskId);
                    bootstrap.Modal.getInstance(document.getElementById('editTaskModal')).hide();
                }
            });
            
            document.getElementById('prevDayBtn').addEventListener('click', () => {
                currentDate.setDate(currentDate.getDate() - 1);
                updateDateDisplay();
            });
            
            document.getElementById('nextDayBtn').addEventListener('click', () => {
                currentDate.setDate(currentDate.getDate() + 1);
                updateDateDisplay();
            });
            
            document.getElementById('logoutBtn').addEventListener('click', () => {
                auth.signOut().then(() => {
                    window.location.reload();
                });
            });
            
            // تحديث الواجهة
            updateDateDisplay();
            checkConnection();
        }

        // 9. بدء التطبيق
        document.addEventListener('DOMContentLoaded', () => {
            if (checkConnection()) {
                auth.signInAnonymously()
                    .then(() => {
                        console.log("تم الاتصال بنجاح");
                        hideError();
                        initApp();
                    })
                    .catch((error) => {
                        console.error("خطأ في الاتصال:", error);
                        showError(`حدث خطأ في الاتصال: ${error.message || 'يرجى المحاولة لاحقًا'}`);
                    });
            }
        });

        // 10. تحديث حالة الاتصال عند التغيير
        window.addEventListener('online', checkConnection);
        window.addEventListener('offline', checkConnection);
    </script>
</body>
</html>
