<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SYM Algeria - تقارير المخزون</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #e30613; /* اللون الأحمر لشركة SYM */
            --secondary-color: #333;
            --light-color: #f8f9fa;
            --dark-color: #212529;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background-color: #f5f5f5;
            color: var(--dark-color);
        }

        .navbar {
            background-color: var(--primary-color) !important;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .navbar-brand {
            font-weight: 700;
            font-size: 1.5rem;
        }

        .nav-link {
            font-weight: 600;
        }

        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .card-header {
            background-color: var(--primary-color);
            color: white;
            border-bottom: none;
            font-weight: 700;
        }

        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .btn-primary:hover {
            background-color: #c00510;
            border-color: #c00510;
        }

        .btn-outline-primary {
            color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .btn-outline-primary:hover {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
        }

        .table th {
            background-color: var(--primary-color);
            color: white;
            text-align: center;
            vertical-align: middle;
        }

        .table td {
            vertical-align: middle;
        }

        .status-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
        }

        .status-corrected {
            background-color: #d4edda;
            color: #155724;
        }

        .status-in-process {
            background-color: #fff3cd;
            color: #856404;
        }

        .status-not-delivered {
            background-color: #f8d7da;
            color: #721c24;
        }

        .form-control, .form-select {
            border-radius: 8px;
            padding: 10px 15px;
            border: 1px solid #ddd;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.25rem rgba(227, 6, 19, 0.25);
        }

        .logo {
            height: 40px;
            margin-right: 10px;
        }

        .footer {
            background-color: var(--dark-color);
            color: white;
            padding: 20px 0;
            margin-top: 40px;
        }

        /* تعديلات RTL */
        [dir="rtl"] .me-2 {
            margin-left: 0.5rem !important;
            margin-right: 0 !important;
        }

        [dir="rtl"] .ms-2 {
            margin-right: 0.5rem !important;
            margin-left: 0 !important;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <img src="https://via.placeholder.com/150x50?text=SYM+Algeria" alt="SYM Algeria" class="logo">
                نظام إدارة المخزون
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">
                            <i class="fas fa-calendar-day me-1"></i> المهام اليومية
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="appointments.html">
                            <i class="fas fa-calendar-week me-1"></i> المواعيد
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="inventory.html">
                            <i class="fas fa-boxes me-1"></i> المخزون
                        </a>
                    </li>
                </ul>
                <div class="d-flex">
                    <button id="logoutBtn" class="btn btn-outline-light">
                        <i class="fas fa-sign-out-alt me-1"></i> تسجيل الخروج
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="container my-5">
        <div class="row">
            <div class="col-12">
                <div class="card shadow">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h4 class="mb-0">
                                <i class="fas fa-clipboard-list me-2"></i>تقارير المخزون
                            </h4>
                            <button class="btn btn-dark" data-bs-toggle="modal" data-bs-target="#addInventoryModal">
                                <i class="fas fa-plus me-1"></i> إضافة تقرير جديد
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="input-group">
                                    <input type="text" id="searchInventoryInput" class="form-control" placeholder="بحث عن زبون أو مخزني...">
                                    <button class="btn btn-outline-secondary" id="searchInventoryBtn">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <select id="filterStatus" class="form-select">
                                    <option value="all">جميع الحالات</option>
                                    <option value="corrected">تم التصحيح</option>
                                    <option value="in-process">قيد المعالجة</option>
                                    <option value="not-delivered">لم تسلم</option>
                                </select>
                            </div>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-bordered table-hover">
                                <thead>
                                    <tr>
                                        <th>التاريخ</th>
                                        <th>اسم الزبون</th>
                                        <th>الكمية المسلمة</th>
                                        <th>الكمية الموجودة</th>
                                        <th>الفارق</th>
                                        <th>المخزني المسؤول</th>
                                        <th>حالة التقرير</th>
                                        <th>الملاحظات</th>
                                        <th>إجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="inventoryTable">
                                    <!-- التقارير ستظهر هنا -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة إضافة تقرير جديد -->
    <div class="modal fade" id="addInventoryModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">إضافة تقرير مخزون جديد</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="inventoryClient" class="form-label">اسم الزبون</label>
                                <select class="form-select" id="inventoryClient" required>
                                    <option value="" selected disabled>اختر الزبون</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="deliveredQuantity" class="form-label">الكمية المسلمة من الشركة</label>
                                <input type="number" class="form-control" id="deliveredQuantity" required>
                            </div>
                            <div class="mb-3">
                                <label for="existingQuantity" class="form-label">الكمية الموجودة</label>
                                <input type="number" class="form-control" id="existingQuantity" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="inventoryEmployee" class="form-label">المخزني المسؤول</label>
                                <input type="text" class="form-control" id="inventoryEmployee" required>
                            </div>
                            <div class="mb-3">
                                <label for="inventoryStatus" class="form-label">حالة التقرير</label>
                                <select class="form-select" id="inventoryStatus" required>
                                    <option value="corrected">تم التصحيح</option>
                                    <option value="in-process">قيد المعالجة</option>
                                    <option value="not-delivered">لم تسلم</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="inventoryNotes" class="form-label">الملاحظات النهائية</label>
                                <textarea class="form-control" id="inventoryNotes" rows="3"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" id="saveInventoryBtn" class="btn btn-primary">حفظ التقرير</button>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة تعديل التقرير -->
    <div class="modal fade" id="editInventoryModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">تعديل تقرير المخزون</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editInventoryId">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editInventoryClient" class="form-label">اسم الزبون</label>
                                <input type="text" class="form-control" id="editInventoryClient" readonly>
                            </div>
                            <div class="mb-3">
                                <label for="editDeliveredQuantity" class="form-label">الكمية المسلمة من الشركة</label>
                                <input type="number" class="form-control" id="editDeliveredQuantity" required>
                            </div>
                            <div class="mb-3">
                                <label for="editExistingQuantity" class="form-label">الكمية الموجودة</label>
                                <input type="number" class="form-control" id="editExistingQuantity" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editInventoryEmployee" class="form-label">المخزني المسؤول</label>
                                <input type="text" class="form-control" id="editInventoryEmployee" required>
                            </div>
                            <div class="mb-3">
                                <label for="editInventoryStatus" class="form-label">حالة التقرير</label>
                                <select class="form-select" id="editInventoryStatus" required>
                                    <option value="corrected">تم التصحيح</option>
                                    <option value="in-process">قيد المعالجة</option>
                                    <option value="not-delivered">لم تسلم</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="editInventoryNotes" class="form-label">الملاحظات النهائية</label>
                                <textarea class="form-control" id="editInventoryNotes" rows="3"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" id="updateInventoryBtn" class="btn btn-primary">حفظ التغييرات</button>
                    <button type="button" id="deleteInventoryBtn" class="btn btn-danger">حذف التقرير</button>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">
        <div class="container text-center">
            <p class="mb-0">جميع الحقوق محفوظة &copy; 2023 SYM Algeria</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script>
        // تهيئة Firebase
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            databaseURL: "YOUR_DATABASE_URL",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);

        const database = firebase.database();
        const auth = firebase.auth();

        // تسجيل الدخول (يمكنك تغيير هذا لنظام تسجيل دخول حقيقي)
        auth.signInAnonymously()
            .then(() => {
                console.log("تم تسجيل الدخول كمستخدم مجهول");
            })
            .catch((error) => {
                console.error("خطأ في تسجيل الدخول:", error);
            });

        // تسجيل الخروج
        document.getElementById('logoutBtn').addEventListener('click', () => {
            auth.signOut().then(() => {
                window.location.href = 'login.html';
            });
        });

        // كود تقارير المخزون
        document.addEventListener('DOMContentLoaded', function() {
            const inventoryTable = document.getElementById('inventoryTable');
            const searchInventoryInput = document.getElementById('searchInventoryInput');
            const searchInventoryBtn = document.getElementById('searchInventoryBtn');
            const filterStatus = document.getElementById('filterStatus');
            const inventoryClientSelect = document.getElementById('inventoryClient');
            const deliveredQuantityInput = document.getElementById('deliveredQuantity');
            const existingQuantityInput = document.getElementById('existingQuantity');
            const inventoryEmployeeInput = document.getElementById('inventoryEmployee');
            const inventoryStatusSelect = document.getElementById('inventoryStatus');
            const inventoryNotesInput = document.getElementById('inventoryNotes');
            const saveInventoryBtn = document.getElementById('saveInventoryBtn');
            const editInventoryClientInput = document.getElementById('editInventoryClient');
            const editDeliveredQuantityInput = document.getElementById('editDeliveredQuantity');
            const editExistingQuantityInput = document.getElementById('editExistingQuantity');
            const editInventoryEmployeeInput = document.getElementById('editInventoryEmployee');
            const editInventoryStatusSelect = document.getElementById('editInventoryStatus');
            const editInventoryNotesInput = document.getElementById('editInventoryNotes');
            const updateInventoryBtn = document.getElementById('updateInventoryBtn');
            const deleteInventoryBtn = document.getElementById('deleteInventoryBtn');
            
            const addInventoryModal = new bootstrap.Modal(document.getElementById('addInventoryModal'));
            const editInventoryModal = new bootstrap.Modal(document.getElementById('editInventoryModal'));
            
            let inventoryReports = [];
            let clients = [];
            let currentReportId = null;
            
            // تحميل الزبائن من Firebase
            function loadClients() {
                const userId = auth.currentUser?.uid;
                
                if (!userId) return;
                
                database.ref(`users/${userId}/clients`).once('value')
                    .then((snapshot) => {
                        clients = [];
                        inventoryClientSelect.innerHTML = '<option value="" selected disabled>اختر الزبون</option>';
                        
                        if (snapshot.exists()) {
                            const clientsData = snapshot.val();
                            clients = Object.entries(clientsData).map(([id, client]) => ({ id, ...client }));
                            
                            // ملء قائمة الزبائن في النموذج
                            clients.forEach(client => {
                                const option = document.createElement('option');
                                option.value = client.id;
                                option.textContent = client.name;
                                inventoryClientSelect.appendChild(option);
                            });
                        }
                        
                        loadInventoryReports();
                    })
                    .catch(error => {
                        console.error('Error loading clients:', error);
                    });
            }
            
            // تحميل تقارير المخزون من Firebase
            function loadInventoryReports() {
                const userId = auth.currentUser?.uid;
                
                if (!userId) return;
                
                database.ref(`users/${userId}/inventory`).once('value')
                    .then((snapshot) => {
                        inventoryTable.innerHTML = '';
                        inventoryReports = [];
                        
                        if (snapshot.exists()) {
                            const reportsData = snapshot.val();
                            inventoryReports = Object.entries(reportsData).map(([id, report]) => ({ id, ...report }));
                            
                            // تصفية حسب حالة البحث
                            const searchTerm = searchInventoryInput.value.toLowerCase();
                            const statusFilter = filterStatus.value;
                            
                            const filteredReports = inventoryReports.filter(report => {
                                const client = clients.find(c => c.id === report.clientId);
                                const clientName = client ? client.name : '';
                                const matchesSearch = searchTerm === '' || 
                                    clientName.toLowerCase().includes(searchTerm) || 
                                    report.employee.toLowerCase().includes(searchTerm);
                                const matchesStatus = statusFilter === 'all' || report.status === statusFilter;
                                
                                return matchesSearch && matchesStatus;
                            });
                            
                            // عرض التقارير
                            if (filteredReports.length > 0) {
                                filteredReports.forEach(report => {
                                    const reportElement = createInventoryReportElement(report);
                                    inventoryTable.appendChild(reportElement);
                                });
                            } else {
                                inventoryTable.innerHTML = '<tr><td colspan="9" class="text-center py-3 text-muted">لا توجد تقارير مطابقة لمعايير البحث</td></tr>';
                            }
                        } else {
                            inventoryTable.innerHTML = '<tr><td colspan="9" class="text-center py-3 text-muted">لا توجد تقارير مخزون</td></tr>';
                        }
                    })
                    .catch(error => {
                        console.error('Error loading inventory reports:', error);
                    });
            }
            
            // إنشاء عنصر تقرير في واجهة المستخدم
            function createInventoryReportElement(report) {
                const client = clients.find(c => c.id === report.clientId);
                const clientName = client ? client.name : 'غير معروف';
                
                const difference = report.existingQuantity - report.deliveredQuantity;
                const differenceText = difference > 0 ? 
                    `<span class="text-success">+${difference}</span>` : 
                    `<span class="text-danger">${difference}</span>`;
                
                const statusTexts = {
                    'corrected': '<span class="status-badge status-corrected">تم التصحيح</span>',
                    'in-process': '<span class="status-badge status-in-process">قيد المعالجة</span>',
                    'not-delivered': '<span class="status-badge status-not-delivered">لم تسلم</span>'
                };
                
                const row = document.createElement('tr');
                row.dataset.id = report.id;
                
                // تنسيق التاريخ
                const date = new Date(report.createdAt);
                const dateStr = date.toLocaleDateString('ar-EG');
                
                row.innerHTML = `
                    <td>${dateStr}</td>
                    <td>${clientName}</td>
                    <td>${report.deliveredQuantity}</td>
                    <td>${report.existingQuantity}</td>
                    <td>${differenceText}</td>
                    <td>${report.employee}</td>
                    <td>${statusTexts[report.status]}</td>
                    <td>${report.notes || 'لا توجد ملاحظات'}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary edit-report">
                            <i class="fas fa-edit"></i>
                        </button>
                    </td>
                `;
                
                row.querySelector('.edit-report').addEventListener('click', () => openEditInventoryModal(report));
                
                return row;
            }
            
            // فتح نافذة تعديل التقرير
            function openEditInventoryModal(report) {
                currentReportId = report.id;
                
                const client = clients.find(c => c.id === report.clientId);
                const clientName = client ? client.name : 'غير معروف';
                
                editInventoryClientInput.value = clientName;
                editDeliveredQuantityInput.value = report.deliveredQuantity;
                editExistingQuantityInput.value = report.existingQuantity;
                editInventoryEmployeeInput.value = report.employee;
                editInventoryStatusSelect.value = report.status;
                editInventoryNotesInput.value = report.notes || '';
                
                editInventoryModal.show();
            }
            
            // إضافة تقرير جديد
            function addInventoryReport() {
                const clientId = inventoryClientSelect.value;
                const deliveredQuantity = parseInt(deliveredQuantityInput.value);
                const existingQuantity = parseInt(existingQuantityInput.value);
                const employee = inventoryEmployeeInput.value.trim();
                const status = inventoryStatusSelect.value;
                const notes = inventoryNotesInput.value.trim();
                
                if (!clientId || isNaN(deliveredQuantity) || isNaN(existingQuantity) || !employee) {
                    alert('الرجاء ملء جميع الحقول المطلوبة');
                    return;
                }
                
                const userId = auth.currentUser?.uid;
                
                if (!userId) return;
                
                const newReportRef = database.ref(`users/${userId}/inventory`).push();
                newReportRef.set({
                    clientId: clientId,
                    deliveredQuantity: deliveredQuantity,
                    existingQuantity: existingQuantity,
                    employee: employee,
                    status: status,
                    notes: notes,
                    createdAt: firebase.database.ServerValue.TIMESTAMP
                })
                .then(() => {
                    // إعادة تعيين النموذج
                    inventoryClientSelect.value = '';
                    deliveredQuantityInput.value = '';
                    existingQuantityInput.value = '';
                    inventoryEmployeeInput.value = '';
                    inventoryStatusSelect.value = 'corrected';
                    inventoryNotesInput.value = '';
                    
                    addInventoryModal.hide();
                    loadInventoryReports();
                })
                .catch(error => {
                    console.error('Error adding inventory report:', error);
                });
            }
            
            // تحديث تقرير المخزون
            function updateInventoryReport() {
                const deliveredQuantity = parseInt(editDeliveredQuantityInput.value);
                const existingQuantity = parseInt(editExistingQuantityInput.value);
                const employee = editInventoryEmployeeInput.value.trim();
                const status = editInventoryStatusSelect.value;
                const notes = editInventoryNotesInput.value.trim();
                
                if (isNaN(deliveredQuantity) || isNaN(existingQuantity) || !employee || !currentReportId) {
                    alert('الرجاء ملء جميع الحقول المطلوبة');
                    return;
                }
                
                const userId = auth.currentUser?.uid;
                
                if (!userId) return;
                
                database.ref(`users/${userId}/inventory/${currentReportId}`).update({
                    deliveredQuantity: deliveredQuantity,
                    existingQuantity: existingQuantity,
                    employee: employee,
                    status: status,
                    notes: notes
                })
                .then(() => {
                    editInventoryModal.hide();
                    loadInventoryReports();
                })
                .catch(error => {
                    console.error('Error updating inventory report:', error);
                });
            }
            
            // حذف تقرير المخزون
            function deleteInventoryReport() {
                if (!confirm('هل أنت متأكد من حذف هذا التقرير؟')) return;
                
                const userId = auth.currentUser?.uid;
                
                if (!userId || !currentReportId) return;
                
                database.ref(`users/${userId}/inventory/${currentReportId}`).remove()
                .then(() => {
                    editInventoryModal.hide();
                    loadInventoryReports();
                })
                .catch(error => {
                    console.error('Error deleting inventory report:', error);
                });
            }
            
            // البحث عن تقارير المخزون
            function searchInventory() {
                loadInventoryReports();
            }
            
            // أحداث المستخدم
            saveInventoryBtn.addEventListener('click', addInventoryReport);
            updateInventoryBtn.addEventListener('click', updateInventoryReport);
            deleteInventoryBtn.addEventListener('click', deleteInventoryReport);
            
            searchInventoryBtn.addEventListener('click', searchInventory);
            searchInventoryInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') searchInventory();
            });
            
            filterStatus.addEventListener('change', searchInventory);
            
            // تهيئة الصفحة
            loadClients();
        });
    </script>
</body>
</html>
