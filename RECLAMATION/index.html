<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام تسجيل البضائع الناقصة/الزائدة</title>
    <!-- خط Cairo -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        /* الخط الأساسي للموقع والتأثيرات العامة */
        * {
            font-family: 'Cairo', sans-serif;
        }
        body {
            transition: background-color 0.3s, color 0.3s ease;
            min-height: 100vh;
        }

        /* أنماط الوضع الليلي */
        .dark-mode {
            background-color: #1a202c;
            color: #f8f9fa;
        }
        .dark-mode .bg-white {
            background-color: #2d3748;
            color: #f8f9fa;
        }
        .dark-mode .bg-gray-100 {
            background-color: #1a202c;
            color: #f8f9fa;
        }
        .dark-mode .text-gray-700,
        .dark-mode .text-gray-800,
        .dark-mode .text-gray-600 {
            color: #f8f9fa;
        }
        .dark-mode .border-gray-300 { border-color: #4a5568; }
        .dark-mode .focus\:ring-blue-500:focus { --tw-ring-color: #63b3ed; }
        .dark-mode .bg-blue-600 { background-color: #3182ce; }
        .dark-mode .hover\:bg-blue-700:hover { background-color: #2b6cb0; }
        .dark-mode .bg-green-600 { background-color: #38a169; }
        .dark-mode .bg-yellow-600 { background-color: #d69e2e; }
        .dark-mode .bg-indigo-600 { background-color: #667eea; }
        .dark-mode .positive { background-color: #2d4a3a; color: #d1fae5; }
        .dark-mode .negative { background-color: #4a2d2d; color: #fee2e2; }
        .dark-mode .under-review { background-color: #4a3d2d; color: #fef3c7; }
        .dark-mode .completed { background-color: #2d3a4a; color: #dbeafe; }
        .dark-mode .sidebar {
            background-color: #2d3748;
            color: #f8f9fa;
        }
        .dark-mode .sidebar-item:hover {
            background-color: #4a5568;
        }
        .dark-mode .status-pending {
            background-color: #4a2d2d;
            color: #fecaca;
        }
        .dark-mode .status-completed {
            background-color: #2d4a3a;
            color: #d1fae5;
        }
        .dark-mode .records-table thead tr {
            background-color: #3182ce; /* Lighten header for dark mode */
        }

        /* أنماط شريط التنقل */
        .navbar { background-color: #1e3a8a; }

        /* أنماط الشريط الجانبي */
        .sidebar {
            width: 70px;
            height: 100vh;
            position: fixed;
            top: 0;
            right: 0;
            background-color: #f8f9fa;
            transition: width 0.3s;
            z-index: 1000;
            box-shadow: -2px 0 5px rgba(0,0,0,0.1);
        }
        .sidebar:hover {
            width: 200px;
        }
        .sidebar-item {
            padding: 15px;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.3s;
            white-space: nowrap;
            overflow: hidden;
            color: #4a5568; /* Default color for sidebar items */
        }
        .sidebar-item:hover {
            background-color: #e9ecef;
        }
        .sidebar-item i {
            margin-left: 10px;
            font-size: 1.2rem;
            color: #2d3748; /* Default icon color */
        }
        .dark-mode .sidebar-item {
            color: #e2e8f0;
        }
        .dark-mode .sidebar-item i {
            color: #e2e8f0;
        }
        .sidebar-text {
            display: none;
        }
        .sidebar:hover .sidebar-text {
            display: inline;
        }

        /* أنماط المحتوى الرئيسي */
        .main-content {
            margin-right: 70px;
            transition: margin-right 0.3s;
            /* No fixed height here, let content expand */
            min-height: calc(100vh - 80px); /* Adjust based on navbar height */
            padding-top: 80px; /* Space for fixed navbar */
        }
        .sidebar:hover ~ .main-content {
            margin-right: 200px;
        }
        .search-input { transition: width 0.3s; }
        .search-input:focus { width: 300px; }
        .hidden { display: none; }
        .action-btn {
            transition: all 0.3s;
            cursor: pointer;
        }
        .action-btn:hover {
            transform: translateY(-2px);
        }

        /* أنماط تجميع الزبائن */
        .customer-group {
            margin-bottom: 20px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            overflow: hidden;
        }
        .dark-mode .customer-group {
            border-color: #4a5568;
        }
        .customer-header {
            background-color: #4299e1;
            color: white;
            padding: 10px 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .customer-records {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .customer-records.expanded {
            max-height: 5000px; /* Large enough to show all content */
        }

        /* أنماط الحالة */
        .overdue {
            animation: pulse 2s infinite;
        }
        .status-pending {
            background-color: #fee2e2;
            color: #b91c1c;
            padding: 4px 8px;
            border-radius: 12px;
            display: inline-flex;
            align-items: center;
        }
        .status-completed {
            background-color: #d1fae5;
            color: #065f46;
            padding: 4px 8px;
            border-radius: 12px;
            display: inline-flex;
            align-items: center;
        }
        .status-icon {
            margin-left: 4px;
            font-size: 0.8rem;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(220, 38, 38, 0); }
            100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); }
        }

        /* أنماط الأرقام الإنجليزية */
        .english-numbers {
            font-family: 'Arial', sans-serif !important; /* Force Arial for numbers */
        }

        /* أنماط الجدول للملء التلقائي */
        .records-container {
            width: 100%;
            overflow-x: auto;
        }
        .records-table {
            width: 100%;
            min-width: 1200px; /* Minimum width for horizontal scrolling */
        }
        .container {
            max-width: 100%;
            padding: 0 15px;
        }

        /* أنماط صفحة تسجيل الدخول */
        .login-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            width: 100%;
            position: absolute;
            top: 0;
            left: 0;
            background-color: #f4f4f4; /* Default background for login screen */
            z-index: 2000; /* Ensure it's on top */
        }
        .dark-mode .login-screen {
            background-color: #1a202c;
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- شاشة تسجيل الدخول -->
    <div id="loginScreen" class="login-screen">
        <div class="bg-white p-8 rounded-lg shadow-lg max-w-sm w-full">
            <!-- شعار SYM -->
            <div class="flex justify-center mb-6">
                <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/c/cf/SYM_logo_of_Sanyang_Motor_20180408.svg/2480px-SYM_logo_of_Sanyang_Motor_20180408.svg.png" alt="SYM Logo" class="h-20 w-auto">
            </div>

            <h2 class="text-3xl font-bold text-gray-700 mb-6 text-center">
                <i class="fas fa-lock text-blue-600 mr-2"></i> تسجيل الدخول
            </h2>

            <form id="loginForm" action="#" method="POST">
                <div class="mb-5">
                    <label for="loginUsername" class="block text-gray-700 text-sm font-semibold mb-2">اسم المستخدم:</label>
                    <div class="relative">
                        <input type="text" id="loginUsername" name="username" placeholder="أدخل اسم المستخدم"
                               class="w-full p-3 pl-10 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-700"
                               required>
                        <i class="fas fa-user absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    </div>
                </div>

                <div class="mb-6">
                    <label for="loginPassword" class="block text-gray-700 text-sm font-semibold mb-2">كلمة المرور:</label>
                    <div class="relative">
                        <input type="password" id="loginPassword" name="password" placeholder="أدخل كلمة المرور"
                               class="w-full p-3 pl-10 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-700"
                               required>
                        <i class="fas fa-key absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    </div>
                </div>

                <button type="submit"
                        class="w-full bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition ease-in-out duration-300">
                    تسجيل الدخول
                </button>
            </form>

            <div class="text-center mt-6">
                <a href="#" class="text-blue-600 hover:text-blue-800 text-sm font-medium transition ease-in-out duration-300">
                    هل نسيت كلمة المرور؟
                </a>
            </div>
        </div>
    </div>

    <!-- الشريط الجانبي (جزء من التطبيق الرئيسي) -->
    <div class="sidebar hidden" id="appSidebar">
        <div class="sidebar-item" onclick="toggleSection('entryForm')">
            <i class="fas fa-edit"></i>
            <span class="sidebar-text">تسجيل البضائع</span>
        </div>
        <div class="sidebar-item" onclick="toggleSection('recordsTable')">
            <i class="fas fa-table"></i>
            <span class="sidebar-text">سجل البضائع</span>
        </div>
        <div class="sidebar-item" onclick="toggleDarkMode()">
            <i class="fas fa-moon" id="darkModeIcon"></i>
            <span class="sidebar-text">الوضع الليلي</span>
        </div>
        <div class="sidebar-item" onclick="logout()">
            <i class="fas fa-sign-out-alt"></i>
            <span class="sidebar-text">تسجيل الخروج</span>
        </div>
    </div>

    <!-- المحتوى الرئيسي للتطبيق (مخفي افتراضيا حتى تسجيل الدخول) -->
    <div class="main-content hidden" id="mainApplicationContent">
        <!-- شريط التنقل -->
        <nav class="navbar p-4 text-white shadow-lg fixed top-0 w-full z-999">
            <div class="container flex justify-between items-center">
                <div class="flex items-center space-x-2">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/c/cf/SYM_logo_of_Sanyang_Motor_20180408.svg/2480px-SYM_logo_of_Sanyang_Motor_20180408.svg.png" alt="Logo" class="h-12 w-auto">
                    <span class="text-xl font-bold hidden md:block">نظام تسجيل البضائع الناقصة/الزائدة</span>
                </div>
                <div class="flex items-center space-x-4">
                    <div id="currentDate" class="text-white english-numbers"></div>
                </div>
            </div>
        </nav>

        <!-- المحتوى الديناميكي -->
        <div class="container p-6">
            <!-- قسم تسجيل البيانات (مخفي افتراضيا عند البدء) -->
            <div id="entryForm" class="hidden">
                <div class="bg-white p-6 rounded-lg shadow-lg mb-6">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">
                        <i class="fas fa-edit mr-2"></i> تسجيل البضائع الناقصة/الزائدة
                    </h2>
                    <form id="goodsForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div>
                            <label for="date" class="block text-gray-700 mb-2">التاريخ</label>
                            <input type="date" id="date" class="w-full p-3 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500 english-numbers" required>
                        </div>
                        <div>
                            <label for="customer" class="block text-gray-700 mb-2">الزبون</label>
                            <select id="customer" class="w-full p-3 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                                <option value="">جاري تحميل الزبائن...</option>
                            </select>
                        </div>
                        <div>
                            <label for="commercialAgent" class="block text-gray-700 mb-2">العميل التجاري</label>
                            <input type="text" id="commercialAgent" placeholder="أدخل اسم العميل التجاري" class="w-full p-3 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="bcNumber" class="block text-gray-700 mb-2">رقم BC</label>
                            <input type="text" id="bcNumber" placeholder="أدخل رقم BC" class="w-full p-3 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500 english-numbers">
                        </div>
                        <div>
                            <label for="itemCode" class="block text-gray-700 mb-2">كود السلعة</label>
                            <input type="text" id="itemCode" placeholder="أدخل كود السلعة" class="w-full p-3 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500 english-numbers" required>
                        </div>
                        <div>
                            <label for="itemName" class="block text-gray-700 mb-2">اسم القطعة</label>
                            <input type="text" id="itemName" placeholder="أدخل اسم القطعة" class="w-full p-3 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div>
                            <label for="deliveredQty" class="block text-gray-700 mb-2">الكمية المسلمة</label>
                            <input type="number" id="deliveredQty" placeholder="أدخل الكمية المسلمة" class="w-full p-3 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500 english-numbers" required>
                        </div>
                        <div>
                            <label for="receivedQty" class="block text-gray-700 mb-2">الكمية المستلمة</label>
                            <input type="number" id="receivedQty" placeholder="أدخل الكمية المستلمة" class="w-full p-3 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500 english-numbers" required>
                        </div>
                        <div>
                            <label for="warehouseManager" class="block text-gray-700 mb-2">المخزني المسؤول</label>
                            <input type="text" id="warehouseManager" placeholder="اسم المخزني المسؤول" class="w-full p-3 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div>
                            <label for="status" class="block text-gray-700 mb-2">الحالة</label>
                            <select id="status" class="w-full p-3 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                                <option value="قيد الدراسة">قيد الدراسة</option>
                                <option value="تم الدراسة">تم الدراسة</option>
                            </select>
                        </div>
                        <div>
                            <label for="notes" class="block text-gray-700 mb-2">ملاحظات</label>
                            <textarea id="notes" placeholder="أدخل أي ملاحظات" class="w-full p-3 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                        </div>
                        <div>
                            <label for="difference" class="block text-gray-700 mb-2">الفرق</label>
                            <input type="text" id="difference" readonly class="w-full p-3 border rounded bg-gray-100 english-numbers">
                        </div>
                        <div class="flex items-end md:col-span-2">
                            <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white p-3 rounded transition">
                                <i class="fas fa-save mr-2"></i> حفظ التسجيل
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- قسم سجل البضائع (يعرض افتراضيا بعد تسجيل الدخول) -->
            <div id="recordsTable">
                <div class="bg-white p-6 rounded-lg shadow-lg">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-gray-700">
                            <i class="fas fa-table mr-2"></i> سجل البضائع الناقصة/الزائدة
                        </h2>
                        <div class="flex items-center space-x-2">
                            <input type="text" id="customerSearch" placeholder="ابحث باسم الزبون..." class="p-2 border rounded search-input w-40 focus:w-64">
                            <input type="text" id="searchInput" placeholder="ابحث بكود السلعة أو الاسم..." class="p-2 border rounded search-input w-40 focus:w-64 english-numbers">
                            <select id="statusFilter" class="p-2 border rounded">
                                <option value="all">جميع الحالات</option>
                                <option value="قيد الدراسة">قيد الدراسة</option>
                                <option value="تم الدراسة">تم الدراسة</option>
                            </select>
                        </div>
                    </div>
                    <div class="records-container">
                        <div id="recordsContainer"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // تهيئة Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBqYbL6zG9Z6ZQZQZQZQZQZQZQZQZQZQZQ",
            authDomain: "commercial-3ef19.firebaseapp.com",
            databaseURL: "https://commercial-3ef19-default-rtdb.firebaseio.com",
            projectId: "commercial-3ef19",
            storageBucket: "commercial-3ef19.appspot.com",
            messagingSenderId: "1234567890",
            appId: "1:1234567890:web:1234567890abcdef"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // متغيرات عامة
        let allRecords = [];
        let customers = [];

        // العناصر الرئيسية
        const loginScreen = document.getElementById('loginScreen');
        const mainApplicationContent = document.getElementById('mainApplicationContent');
        const appSidebar = document.getElementById('appSidebar');

        // وظيفة للتحقق من حالة تسجيل الدخول
        function checkLoginStatus() {
            const loggedIn = sessionStorage.getItem('loggedIn');
            if (loggedIn === 'true') {
                loginScreen.classList.add('hidden');
                mainApplicationContent.classList.remove('hidden');
                appSidebar.classList.remove('hidden');
                initializeMainApp(); // تهيئة التطبيق الرئيسي عند تسجيل الدخول
            } else {
                loginScreen.classList.remove('hidden');
                mainApplicationContent.classList.add('hidden');
                appSidebar.classList.add('hidden');
            }
        }

        // تهيئة التطبيق الرئيسي (يتم استدعاؤها بعد تسجيل الدخول)
        function initializeMainApp() {
            updateCurrentDate();
            setInterval(updateCurrentDate, 60000); // تحديث التاريخ كل دقيقة

            const today = new Date();
            const formattedDate = today.toISOString().split('T')[0];
            document.getElementById('date').value = formattedDate;

            // تفعيل الوضع الليلي إذا كان مفعلًا
            if (localStorage.getItem('darkMode') === 'true') {
                document.body.classList.add('dark-mode');
                document.getElementById('darkModeIcon').classList.replace('fa-moon', 'fa-sun');
            } else {
                document.getElementById('darkModeIcon').classList.replace('fa-sun', 'fa-moon');
            }

            // تحميل بيانات الزبائن تلقائيا
            loadCustomers();

            // تحميل البيانات من Firebase
            loadRecords();

            // عرض قسم السجلات افتراضيا بعد تسجيل الدخول
            document.getElementById('recordsTable').classList.remove('hidden');
            document.getElementById('entryForm').classList.add('hidden'); // إخفاء نموذج الإدخال افتراضيًا

            // التحقق من السجلات المتأخرة كل 5 دقائق
            setInterval(checkOverdueRecords, 300000);
            checkOverdueRecords();
        }


        // تشغيل التحقق من حالة تسجيل الدخول عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', checkLoginStatus);

        // وظيفة تسجيل الدخول
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;

            const correctUsername = 'KERNANI';
            const correctPassword = 'KRHL0214';

            if (username === correctUsername && password === correctPassword) {
                Swal.fire({
                    icon: 'success',
                    title: 'تم تسجيل الدخول بنجاح!',
                    text: 'مرحبًا بك!',
                    timer: 1500,
                    showConfirmButton: false
                }).then(() => {
                    sessionStorage.setItem('loggedIn', 'true'); // تعيين علامة تسجيل الدخول
                    checkLoginStatus(); // تحديث واجهة المستخدم
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'خطأ في تسجيل الدخول',
                    text: 'اسم المستخدم أو كلمة المرور غير صحيحة. يرجى المحاولة مرة أخرى.'
                });
            }
        });

        // وظيفة تسجيل الخروج
        function logout() {
            Swal.fire({
                title: 'هل أنت متأكد من تسجيل الخروج؟',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'نعم، تسجيل الخروج',
                cancelButtonText: 'إلغاء'
            }).then((result) => {
                if (result.isConfirmed) {
                    sessionStorage.removeItem('loggedIn'); // إزالة علامة تسجيل الدخول
                    Swal.fire({
                        icon: 'info',
                        title: 'تم تسجيل الخروج بنجاح!',
                        timer: 1500,
                        showConfirmButton: false
                    }).then(() => {
                        checkLoginStatus(); // تحديث واجهة المستخدم
                        // إعادة تعيين حقول تسجيل الدخول
                        document.getElementById('loginUsername').value = '';
                        document.getElementById('loginPassword').value = '';
                    });
                }
            });
        }
        window.logout = logout; // لجعلها متاحة من onclick في HTML


        // تحديث التاريخ والوقت الحالي
        function updateCurrentDate() {
            const now = new Date();
            const options = {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            };
            const dateString = now.toLocaleDateString('ar-EG', options);
            const englishDate = dateString.replace(/[٠-٩]/g, d => "٠١٢٣٤٥٦٧٨٩".indexOf(d));
            document.getElementById('currentDate').textContent = englishDate;
        }

        // تبديل الأقسام
        function toggleSection(sectionId) {
            document.getElementById('entryForm').classList.add('hidden');
            document.getElementById('recordsTable').classList.add('hidden');
            document.getElementById(sectionId).classList.remove('hidden');
        }
        window.toggleSection = toggleSection; // لجعلها متاحة من onclick في HTML

        // تبديل الوضع الليلي
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));

            const icon = document.getElementById('darkModeIcon');
            if (document.body.classList.contains('dark-mode')) {
                icon.classList.replace('fa-moon', 'fa-sun');
            } else {
                icon.classList.replace('fa-sun', 'fa-moon');
            }
        }
        window.toggleDarkMode = toggleDarkMode; // لجعلها متاحة من onclick في HTML

        // حساب الفرق بين الكميات
        document.getElementById('deliveredQty').addEventListener('input', calculateDifference);
        document.getElementById('receivedQty').addEventListener('input', calculateDifference);

        function calculateDifference() {
            const delivered = parseFloat(document.getElementById('deliveredQty').value) || 0;
            const received = parseFloat(document.getElementById('receivedQty').value) || 0;
            const difference = received - delivered;

            const differenceField = document.getElementById('difference');
            differenceField.value = difference;

            if (difference > 0) {
                differenceField.className = 'w-full p-3 border rounded positive english-numbers';
            } else if (difference < 0) {
                differenceField.className = 'w-full p-3 border rounded negative english-numbers';
            } else {
                differenceField.className = 'w-full p-3 border rounded bg-gray-100 english-numbers';
            }
        }

        // تحميل بيانات الزبائن من Google Sheets تلقائيا من عمود CLIENT
        async function loadCustomers() {
            try {
                const sheetId = '2PACX-1vTVFnFkW6NhZpBb3Wty2qAa97GNKg43Um0JdzqyTobWS-vtRNSJ4_aRjJ3OS-tG_1-GPOSeTr5levqI';
                const csvUrl = `https://docs.google.com/spreadsheets/d/e/${sheetId}/pub?gid=0&single=true&output=csv`;

                const response = await fetch(csvUrl);
                if (!response.ok) throw new Error('فشل في تحميل الملف');

                const csvData = await response.text();

                customers = parseCSV(csvData);

                if (customers.length === 0) {
                    throw new Error('لا توجد بيانات في الملف');
                }

                const customerSelect = document.getElementById('customer');
                customerSelect.innerHTML = '<option value="">اختر الزبون</option>';

                const clientNames = new Set();

                customers.forEach(row => {
                    const clientKey = Object.keys(row).find(key => key.toLowerCase() === 'client');
                    if (clientKey && row[clientKey] && row[clientKey].trim() !== '') {
                        clientNames.add(row[clientKey].trim());
                    }
                });

                if (clientNames.size === 0) {
                    throw new Error('لا توجد أسماء زبائن في عمود CLIENT');
                }

                clientNames.forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    customerSelect.appendChild(option);
                });

                console.log('تم تحميل بيانات الزبائن بنجاح:', clientNames);

            } catch (error) {
                console.error('حدث خطأ أثناء تحميل بيانات الزبائن:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'خطأ',
                    text: 'حدث خطأ أثناء تحميل بيانات الزبائن: ' + error.message
                });

                const customerSelect = document.getElementById('customer');
                customerSelect.innerHTML = `
                    <option value="">اختر الزبون</option>
                    <option value="زبون 1">زبون 1</option>
                    <option value="زبون 2">زبون 2</option>
                    <option value="زبون 3">زبون 3</option>
                `;
            }
        }

        // دالة لتحويل CSV إلى JSON
        function parseCSV(csv) {
            const lines = csv.split('\n').filter(line => line.trim() !== '');
            if (lines.length < 1) return [];

            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));

            const result = [];

            for (let i = 1; i < lines.length; i++) {
                const currentline = lines[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);

                const obj = {};
                for (let j = 0; j < headers.length; j++) {
                    obj[headers[j]] = currentline[j] ? currentline[j].trim().replace(/"/g, '') : '';
                }

                result.push(obj);
            }

            return result;
        }

        // تحميل السجلات من Firebase
        function loadRecords() {
            database.ref('goodsRecords').on('value', (snapshot) => {
                const recordsData = snapshot.val();
                if (!recordsData) {
                    allRecords = [];
                    renderRecordsByCustomer([]);
                    return;
                }

                allRecords = Object.keys(recordsData).map(key => {
                    return { ...recordsData[key], id: key };
                });

                renderRecordsByCustomer(allRecords);
            });
        }

        // عرض البيانات مجمعة حسب الزبون
        function renderRecordsByCustomer(records) {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const customerSearchTerm = document.getElementById('customerSearch').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;

            const filteredRecords = records
                .filter(record => {
                    const matchesSearch =
                        (record.itemCode && record.itemCode.toString().toLowerCase().includes(searchTerm)) ||
                        (record.itemName && record.itemName.toLowerCase().includes(searchTerm));

                    const matchesCustomer =
                        record.customer && record.customer.toLowerCase().includes(customerSearchTerm);

                    const matchesStatus =
                        statusFilter === 'all' ||
                        record.status === statusFilter;

                    return matchesSearch && matchesCustomer && matchesStatus;
                })
                .sort((a, b) => new Date(b.date) - new Date(a.date));

            const groupedRecords = {};
            filteredRecords.forEach(record => {
                if (!groupedRecords[record.customer]) {
                    groupedRecords[record.customer] = [];
                }
                groupedRecords[record.customer].push(record);
            });

            const container = document.getElementById('recordsContainer');
            container.innerHTML = '';

            if (Object.keys(groupedRecords).length === 0) {
                container.innerHTML = `
                    <div class="text-center p-4 text-gray-500">
                        لا توجد سجلات متاحة
                    </div>
                `;
                return;
            }

            for (const customer in groupedRecords) {
                const customerGroup = document.createElement('div');
                customerGroup.className = 'customer-group mb-6';

                const customerHeader = document.createElement('div');
                customerHeader.className = 'customer-header';
                customerHeader.innerHTML = `
                    <span>${customer}</span>
                    <i class="fas fa-chevron-down"></i>
                `;

                const customerRecordsDiv = document.createElement('div');
                customerRecordsDiv.className = 'customer-records';

                const table = document.createElement('table');
                table.className = 'records-table w-full border-collapse';
                table.innerHTML = `
                    <thead>
                        <tr class="bg-blue-600 text-white">
                            <th class="p-3">التاريخ</th>
                            <th class="p-3">العميل التجاري</th>
                            <th class="p-3">رقم BC</th>
                            <th class="p-3">كود السلعة</th>
                            <th class="p-3">اسم القطعة</th>
                            <th class="p-3">المسلمة</th>
                            <th class="p-3">المستلمة</th>
                            <th class="p-3">الفرق</th>
                            <th class="p-3">المخزني</th>
                            <th class="p-3">الحالة</th>
                            <th class="p-3">ملاحظات</th>
                            <th class="p-3">آخر تعديل</th>
                            <th class="p-3">إجراءات</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${groupedRecords[customer].map(record => createRecordRow(record)).join('')}
                    </tbody>
                `;

                customerRecordsDiv.appendChild(table);
                customerGroup.appendChild(customerHeader);
                customerGroup.appendChild(customerRecordsDiv);
                container.appendChild(customerGroup);

                customerHeader.addEventListener('click', () => {
                    customerRecordsDiv.classList.toggle('expanded');
                    const icon = customerHeader.querySelector('i');
                    icon.classList.toggle('fa-chevron-down');
                    icon.classList.toggle('fa-chevron-up');
                });
            }
        }

        // إنشاء صف للسجل
        function createRecordRow(record) {
            const difference = record.receivedQty - record.deliveredQty;
            let differenceClass = 'px-2 py-1 rounded-full text-xs english-numbers';

            if (difference > 0) {
                differenceClass += ' bg-green-100 text-green-800';
            } else if (difference < 0) {
                differenceClass += ' bg-red-100 text-red-800';
            } else {
                differenceClass += ' bg-gray-100 text-gray-800';
            }

            const recordDate = new Date(record.date);
            const today = new Date();
            const oneMonthAgo = new Date(today.setMonth(today.getMonth() - 1));
            const isOverdue = record.status === 'قيد الدراسة' && recordDate < oneMonthAgo;

            let statusElement;
            if (record.status === 'قيد الدراسة') {
                statusElement = `
                    <span class="status-pending">
                        ${record.status}
                        <i class="fas fa-hourglass-half status-icon"></i>
                    </span>
                `;
            } else {
                statusElement = `
                    <span class="status-completed">
                        ${record.status}
                        <i class="fas fa-check-circle status-icon"></i>
                    </span>
                `;
            }

            return `
                <tr class="${isOverdue ? 'overdue bg-red-50' : ''}">
                    <td class="p-3 english-numbers">${record.date}</td>
                    <td class="p-3">${record.commercialAgent || '-'}</td>
                    <td class="p-3 english-numbers">${record.bcNumber || '-'}</td>
                    <td class="p-3 english-numbers">${record.itemCode}</td>
                    <td class="p-3">${record.itemName}</td>
                    <td class="p-3 text-center english-numbers">${record.deliveredQty}</td>
                    <td class="p-3 text-center english-numbers">${record.receivedQty}</td>
                    <td class="p-3 text-center">
                        <span class="${differenceClass}">${difference}</span>
                    </td>
                    <td class="p-3">${record.warehouseManager}</td>
                    <td class="p-3 text-center">
                        ${statusElement}
                    </td>
                    <td class="p-3">${record.notes || '-'}</td>
                    <td class="p-3 english-numbers">${record.lastModified ? record.lastModified.date + '<br>' + (record.lastModified.note || 'بدون ملاحظات') : '-'}</td>
                    <td class="p-3">
                        <button onclick="editRecord('${record.id}')" class="action-btn text-blue-600 hover:text-blue-800 mr-2">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteRecord('${record.id}')" class="action-btn text-red-600 hover:text-red-800">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
        }

        // إضافة سجل جديد إلى Firebase
        document.getElementById('goodsForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const record = {
                id: Date.now().toString(),
                date: document.getElementById('date').value,
                customer: document.getElementById('customer').value,
                commercialAgent: document.getElementById('commercialAgent').value,
                bcNumber: document.getElementById('bcNumber').value,
                itemCode: document.getElementById('itemCode').value,
                itemName: document.getElementById('itemName').value,
                deliveredQty: parseFloat(document.getElementById('deliveredQty').value),
                receivedQty: parseFloat(document.getElementById('receivedQty').value),
                warehouseManager: document.getElementById('warehouseManager').value,
                status: document.getElementById('status').value,
                notes: document.getElementById('notes').value,
                difference: parseFloat(document.getElementById('difference').value) || 0
            };

            database.ref('goodsRecords/' + record.id).set(record)
                .then(() => {
                    this.reset();
                    document.getElementById('date').value = new Date().toISOString().split('T')[0];
                    document.getElementById('difference').value = '';
                    document.getElementById('difference').className = 'w-full p-3 border rounded bg-gray-100 english-numbers';

                    Swal.fire({
                        icon: 'success',
                        title: 'تم الحفظ',
                        text: 'تم تسجيل البيانات بنجاح',
                        timer: 1500,
                        showConfirmButton: false
                    });
                })
                .catch((error) => {
                    Swal.fire({
                        icon: 'error',
                        title: 'خطأ',
                        text: 'حدث خطأ أثناء حفظ البيانات: ' + error.message
                    });
                });
        });

        // تعديل سجل
        window.editRecord = function(id) {
            database.ref('goodsRecords/' + id).once('value')
                .then((snapshot) => {
                    const record = snapshot.val();
                    if (!record) return;

                    const customerOptions = customers.map(c => {
                        const clientKey = Object.keys(c).find(key => key.toLowerCase() === 'client');
                        const clientName = clientKey ? c[clientKey].trim() : '';
                        const selected = (record.customer === clientName) ? 'selected' : '';
                        return `<option value="${clientName}" ${selected}>${clientName}</option>`;
                    }).join('');

                    Swal.fire({
                        title: 'تعديل السجل',
                        html: `
                            <label for="editDate" class="swal2-label">التاريخ</label>
                            <input type="date" id="editDate" class="swal2-input english-numbers" value="${record.date}">
                            <label for="editCustomer" class="swal2-label">الزبون</label>
                            <select id="editCustomer" class="swal2-select">
                                ${customerOptions}
                            </select>
                            <label for="editCommercialAgent" class="swal2-label">العميل التجاري</label>
                            <input type="text" id="editCommercialAgent" class="swal2-input" value="${record.commercialAgent || ''}" placeholder="العميل التجاري">
                            <label for="editBcNumber" class="swal2-label">رقم BC</label>
                            <input type="text" id="editBcNumber" class="swal2-input english-numbers" value="${record.bcNumber || ''}" placeholder="رقم BC">
                            <label for="editItemCode" class="swal2-label">كود السلعة</label>
                            <input type="text" id="editItemCode" class="swal2-input english-numbers" value="${record.itemCode}" placeholder="كود السلعة">
                            <label for="editItemName" class="swal2-label">اسم القطعة</label>
                            <input type="text" id="editItemName" class="swal2-input" value="${record.itemName}" placeholder="اسم القطعة">
                            <label for="editDeliveredQty" class="swal2-label">الكمية المسلمة</label>
                            <input type="number" id="editDeliveredQty" class="swal2-input english-numbers" value="${record.deliveredQty}" placeholder="الكمية المسلمة">
                            <label for="editReceivedQty" class="swal2-label">الكمية المستلمة</label>
                            <input type="number" id="editReceivedQty" class="swal2-input english-numbers" value="${record.receivedQty}" placeholder="الكمية المستلمة">
                            <label for="editWarehouseManager" class="swal2-label">المخزني المسؤول</label>
                            <input type="text" id="editWarehouseManager" class="swal2-input" value="${record.warehouseManager}" placeholder="المخزني المسؤول">
                            <label for="editStatus" class="swal2-label">الحالة</label>
                            <select id="editStatus" class="swal2-select">
                                <option value="قيد الدراسة" ${record.status === 'قيد الدراسة' ? 'selected' : ''}>قيد الدراسة</option>
                                <option value="تم الدراسة" ${record.status === 'تم الدراسة' ? 'selected' : ''}>تم الدراسة</option>
                            </select>
                            <label for="editNotes" class="swal2-label">ملاحظات</label>
                            <textarea id="editNotes" class="swal2-textarea" placeholder="ملاحظات">${record.notes || ''}</textarea>
                            <label for="editLastModifiedNote" class="swal2-label">ملاحظة آخر تعديل (اختياري)</label>
                            <input type="text" id="editLastModifiedNote" class="swal2-input" placeholder="اكتب ملاحظة حول التعديل">
                        `,
                        showCancelButton: true,
                        confirmButtonText: 'حفظ التعديلات',
                        cancelButtonText: 'إلغاء',
                        confirmButtonColor: '#3085d6',
                        preConfirm: () => {
                            const delivered = parseFloat(document.getElementById('editDeliveredQty').value) || 0;
                            const received = parseFloat(document.getElementById('editReceivedQty').value) || 0;
                            const difference = received - delivered;
                            const lastModifiedNote = document.getElementById('editLastModifiedNote').value;

                            const updatedRecord = {
                                id: record.id,
                                date: document.getElementById('editDate').value,
                                customer: document.getElementById('editCustomer').value,
                                commercialAgent: document.getElementById('editCommercialAgent').value,
                                bcNumber: document.getElementById('editBcNumber').value,
                                itemCode: document.getElementById('editItemCode').value,
                                itemName: document.getElementById('editItemName').value,
                                deliveredQty: delivered,
                                receivedQty: received,
                                warehouseManager: document.getElementById('editWarehouseManager').value,
                                status: document.getElementById('editStatus').value,
                                notes: document.getElementById('editNotes').value,
                                difference: difference,
                                lastModified: {
                                    date: new Date().toISOString().split('T')[0],
                                    note: lastModifiedNote
                                }
                            };

                            return database.ref('goodsRecords/' + record.id).update(updatedRecord)
                                .then(() => {
                                    Swal.fire('تم التعديل!', 'تم تحديث السجل بنجاح.', 'success');
                                })
                                .catch((error) => {
                                    Swal.showValidationMessage('حدث خطأ أثناء التحديث: ' + error.message);
                                });
                        }
                    });
                });
        };

        // حذف سجل من Firebase
        window.deleteRecord = function(id) {
            Swal.fire({
                title: 'هل أنت متأكد؟',
                text: 'سيتم حذف هذا السجل نهائيًا!',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'نعم، احذف!',
                cancelButtonText: 'إلغاء',
                confirmButtonColor: '#d33'
            }).then((result) => {
                if (result.isConfirmed) {
                    database.ref('goodsRecords/' + id).remove()
                        .then(() => {
                            Swal.fire('تم الحذف!', 'تم حذف السجل بنجاح.', 'success');
                        })
                        .catch((error) => {
                            Swal.fire('خطأ!', 'حدث خطأ أثناء الحذف: ' + error.message, 'error');
                        });
                }
            });
        };

        // البحث والتصفية
        document.getElementById('searchInput').addEventListener('input', () => {
            renderRecordsByCustomer(allRecords);
        });

        document.getElementById('customerSearch').addEventListener('input', () => {
            renderRecordsByCustomer(allRecords);
        });

        document.getElementById('statusFilter').addEventListener('change', () => {
            renderRecordsByCustomer(allRecords);
        });

        // التحقق من السجلات المتأخرة
        function checkOverdueRecords() {
            const today = new Date();
            const oneMonthAgo = new Date(today.setMonth(today.getMonth() - 1));

            const overdueRecords = allRecords.filter(record => {
                const recordDate = new Date(record.date);
                return record.status === 'قيد الدراسة' && recordDate < oneMonthAgo;
            });

            if (overdueRecords.length > 0) {
                Swal.fire({
                    icon: 'warning',
                    title: 'تنبيه',
                    html: `هناك ${overdueRecords.length} سجل (سجلات) متأخر (ة) تحتاج إلى مراجعة.`,
                    confirmButtonText: 'حسناً'
                });
            }
        }
    </script>
</body>
</html>
